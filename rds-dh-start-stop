podTemplate(
    containers: [
        containerTemplate(
            name: 'sch-code-builder',
            image: '791532114280.dkr.ecr.us-east-1.amazonaws.com/sch-build-agent:sch-sit2-terragrunt',
            command: 'cat',
            ttyEnabled: true,
            resourceLimitEphemeralStorage: '10Gi',
            resourceLimitMemory: '16Gi'
        )
    ],
    volumes: [
        dynamicPVC(
            requestsSize : '50Gi',
            mountPath: '/var/lib/containers/storage/vfs'
        )
    ],
    envVars: [
        envVar(key: 'Dev', value: 'swashikan'),
        envVar(key: 'Dev2', value: 'lsac-dev-sch-master-test lsac-dev-sch-alpha-app lsac-dev-sch-alpha-analytics'),
        envVar(key: 'Dev3', value: 'swashikan Dev3'),
        envVar(key: 'Sit', value: 'swashikan Sit'),
        envVar(key: 'Sit2', value: 'swashikan Sit2'),
        envVar(key: 'Sit3', value: 'swashikan Sit3'),
        envVar(key: 'Poc', value: 'swashikan Poc'),
        envVar(key: 'Rtest', value: 'swashikan Rtest')

    ]
) 
{

    properties([
        parameters([
            choice(
            name: 'Environments', 
            choices: ['Dev','Dev2'],
            description: 'Select the Environment'
            ),
            choice(
            name: 'Components', 
            choices: ['Status', 'Start', 'Stop'],
            description: 'Select the State of Instances'
            )

        ])
    ])
    node(POD_LABEL) {
stage('Status Dev2 RDS Instances') {


                script {
                    if (params.Components.contains('Status') ) {
container('sch-code-builder'){
                    // Stage 1: Pull Docker image using AWS credentials
                    withCredentials([[
                        $class: 'AmazonWebServicesCredentialsBinding',
                        accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                        credentialsId: 'aws_jenkins_dev', // Replace with your AWS credentials ID
                        secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                    ]]) {
                    switch(params.Environments) {
                        case "Dev": sh " echo $Dev > rds "; break
                        case "Dev2": sh " echo $Dev2 > rds "; break
                        case "Dev3": sh " echo $Dev2 > rds "; break
                        case "Sit": sh " echo $Sit > rds "; break
                        case "Sit2": sh " echo $Sit2 > rds "; break
                        case "Sit3": sh " echo $Sit3 > rds "; break
                        case "Poc": sh " echo $Poc > rds "; break
                        case "Rtest": sh " echo $Rtest > rds "; break
                    }
                        sh '''
                            for i in `cat rds`; do
                                set +x
                                aws rds describe-db-instances --db-instance-identifier $i --query 'DBInstances[].[DBInstanceIdentifier,DBInstanceStatus]' --output text >> status.txt
                            done
                            cat status.txt
                   '''
                    }
                }
             }
        }
}
stage('Start Dev2 RDS Instances') {


                script {
                    if (params.Environments.contains('Dev2') && params.Components.contains('Start') ) {
container('sch-code-builder'){
                    // Stage 1: Pull Docker image using AWS credentials
                    withCredentials([[
                        $class: 'AmazonWebServicesCredentialsBinding',
                        accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                        credentialsId: 'aws_jenkins_dev', // Replace with your AWS credentials ID
                        secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                    ]]) {
                    switch(params.Environments) {
                        case "Dev": sh " echo $Dev > rds "; break
                        case "Dev2": sh " echo $Dev2 > rds "; break
                        case "Dev3": sh " echo $Dev2 > rds "; break
                        case "Sit": sh " echo $Sit > rds "; break
                        case "Sit2": sh " echo $Sit2 > rds "; break
                        case "Sit3": sh " echo $Sit3 > rds "; break
                        case "Poc": sh " echo $Poc > rds "; break
                        case "Rtest": sh " echo $Rtest > rds "; break
                    }
                        sh '''
                            for i in `cat rds`; do
                                set +x
                                master=`aws rds describe-db-instances --db-instance-identifier $i --query 'DBInstances[].[DBInstanceIdentifier,DBInstanceStatus]' --output text | awk '{print $2}'`
                                if [ "$master" = "stopped" ]; then
                                    aws rds start-db-instance --db-instance-identifier $i --region us-east-1 2>&1 > /dev/null
                                    echo "$i is Started"
                                else
                                    echo "$i is in $master State, Needed to be Stopped Before Turning On."
    
                                fi
                            done
                   '''
                    }
                }
             }
        }
}

stage('Stop Dev2 RDS Instances') {


                script {
                    if (params.Environments.contains('Dev2') && params.Components.contains('Stop')) {
container('sch-code-builder'){
                    // Stage 1: Pull Docker image using AWS credentials
                    withCredentials([[
                        $class: 'AmazonWebServicesCredentialsBinding',
                        accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                        credentialsId: 'aws_jenkins_dev', // Replace with your AWS credentials ID
                        secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                    ]]) {
                    switch(params.Environments) {
                        case "Dev": sh " echo $Dev > rds "; break
                        case "Dev2": sh " echo $Dev2 > rds "; break
                        case "Dev3": sh " echo $Dev2 > rds "; break
                        case "Sit": sh " echo $Sit > rds "; break
                        case "Sit2": sh " echo $Sit2 > rds "; break
                        case "Sit3": sh " echo $Sit3 > rds "; break
                        case "Poc": sh " echo $Poc > rds "; break
                        case "Rtest": sh " echo $Rtest > rds "; break
                    }
                        sh '''
                            for i in `cat rds`; do
                            master=`aws rds describe-db-instances --db-instance-identifier $i --query 'DBInstances[].[DBInstanceIdentifier,DBInstanceStatus]' --output text | awk '{print $2}'`

                            if [ "$master" = "stopped" ] || [ "$master" = "stopping" ] || [ "$master" = "starting" ]; then
                                echo "$i is not in Available State, Check Status"
                            else
                                aws rds stop-db-instance --db-instance-identifier $i --region us-east-1 2>&1 > /dev/null
                                echo "$i is Stopped"
                            fi
                            done
                   '''
                    }
                }
             }
        }
}
}
}
