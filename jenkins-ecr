
podTemplate(
  containers: [
    containerTemplate(
      name: 'swashikan', 
      image: '791532114280.dkr.ecr.us-east-1.amazonaws.com/swashikan:lsacone',
      command: 'cat',
      ttyEnabled: true,
      resourceLimitEphemeralStorage: '10Gi',
      resourceLimitMemory: '2Gi'
    ),
    containerTemplate(
      name: 'terragrunt-2', 
      image: '791532114280.dkr.ecr.us-east-1.amazonaws.com/terragrunt-build:bcb224c33-2023-04-05-102153',
      command: 'cat',
      ttyEnabled: true,
      resourceLimitEphemeralStorage: '10Gi',
      resourceLimitMemory: '2Gi'
    )
  ],
  volumes: [
    dynamicPVC(requestsSize : '200Gi', mountPath: '/home/node/data')
  ]
) 

{
  node(POD_LABEL) {
    stage('Run init') {
        container('swashikan') {
          checkout scm
          script {
            withCredentials([[
                $class: 'AmazonWebServicesCredentialsBinding',
                credentialsId: "aws_sqdsam_jenkins",
                accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
            ],[
              $class: 'SSHUserPrivateKeyBinding',
              credentialsId: "jenkins_github_ssh_key",
              usernameVariable: "username",
              keyFileVariable: "ssh_key",
              passphraseVariable: "passphrase",

            ]]) {
                sh '''
                  df -h
                  mkdir ~/.ssh
                  ssh-keyscan github.com >> ~/.ssh/known_hosts
                  chmod 600 $ssh_key
                  echo "IdentityFile $ssh_key" > ~/.ssh/config
                  cd terragrunt/live/sdqsam/lsac-perf-sdq

                '''
            }
          }
        }
    }
    stage('Run plan') {
      container('terragrunt-2'){
        script {
            withCredentials([[
                $class: 'AmazonWebServicesCredentialsBinding',
                credentialsId: "aws_sqdsam_jenkins",
                accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
            ],[
              $class: 'SSHUserPrivateKeyBinding',
              credentialsId: "jenkins_github_ssh_key",
              usernameVariable: "username",
              keyFileVariable: "ssh_key",
              passphraseVariable: "passphrase",

            ]]) {
                sh '''
                  mkdir ~/.ssh
                  ssh-keyscan github.com >> ~/.ssh/known_hosts
                  chmod 600 $ssh_key
                  echo "IdentityFile $ssh_key" > ~/.ssh/config
                  cd terragrunt/live/sdqsam/lsac-perf-sdq
                '''
            }
          }
      }
    }
  }
}
